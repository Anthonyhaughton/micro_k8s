# Don't set ansible_python_interpreter globally yet

- name: Bootstrap host (install venv + kubernetes lib)
  hosts: homelab
  gather_facts: true
  become: true
  tasks:
    - name: Ensure python3-venv is installed
      ansible.builtin.apt:
        name: python3-venv
        state: present

    - name: Create Python venv
      ansible.builtin.pip:
        name: kubernetes
        virtualenv: /opt/ansible_venv
        virtualenv_command: python3 -m venv

# Then switch to the new interpreter
- name: Use venv for all cluster tasks
  hosts: homelab
  gather_facts: true
  vars:
    ansible_python_interpreter: /opt/ansible_venv/bin/python
  tasks:
    - name: Confirm Python version
      ansible.builtin.command: /opt/ansible_venv/bin/python --version
